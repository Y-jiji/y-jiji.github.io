<!DOCTYPE html>
<head>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <link rel="stylesheet" href="theme.css">
    <link rel="stylesheet" href="post.css">
    <script src="js-yaml.js"></script>
    <script src="yamlFront.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.2/dist/markdown-it.min.js"></script>
    <script type="text/x-mathjax-config">
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']]
            }
        };
    </script>
</head>

<body>
    <div id="navi-wrapper">
        <div id="icon"><h3>Y-jiji's Blog</h3></div>
        <div id="navi"></div> <!-- navigation container -->
    </div>
    <!-- blog content container -->
    <div id="cont">
        <div> Loading Content ... </div>
    </div>
    <!-- blog list container -->
    <div id="prev">
        <h1 id="prev-header"> ---------- Read More ---------- </h1>
    </div>
    <!-- foot content container -->
    <div id="foot"></div>

    <!-- script for loading blog posts from source -->
    <script src="config.js"></script>        <!-- load global config   -->
    <script src="navigation.js"></script>    <!-- load navigation bar  -->
    <!-- script for navigation bar animation -->
    <script type="module">
        // a scrolling var
        var scrollingLock = false;
        var lastScrollTop = 0;
        // hide navigation bar
        function hideNavigation() {
            let navi = document.querySelector("#navi-wrapper");
            let naviClass = navi.getAttribute("class") || "";
            navi.setAttribute("class", (naviClass.replace("hidding", "") + " hidding").replace(/  +/, " ").replace(/^ /, ""));
        }
        // reveal navigation bar
        function revealNavigation() {
            let navi = document.querySelector("#navi-wrapper");
            let naviClass = navi.getAttribute("class") || "";
            navi.setAttribute("class", (naviClass + " ").replaceAll("hidding", "").replace(/  +/, " ").replace(/^ /, ""));
        }
        // reveal navigation bar when scrolling up
        // hide navigation bar when scrolling down
        window.addEventListener("scroll", (_ev) => {
            if(scrollingLock) { return; }
            scrollingLock = true;
            var st = window.pageYOffset || document.documentElement.scrollTop;
            if (st > lastScrollTop) {
                hideNavigation();
            } else if (st < lastScrollTop - 20) {
                revealNavigation();
            }
            lastScrollTop = st <= 0 ? 0 : st;
            scrollingLock = false;
        })
        // reveal navigation bar when mouse is moved to the top
        var mouseMoveLock = false;
        var lastMouseY = 0;
        window.addEventListener("mousemove", (ev) => {
            mouseMoveLock = true;
            let event = ev || window.event;
            let mousePos = { x: event.clientX, y: event.clientY };
            let height = (document.getElementById("navi-wrapper").clientHeight) * 0.9;
            if (mousePos.y < height) {
                revealNavigation();
            } else if (mousePos.y > lastMouseY) {
                hideNavigation();
            }
            lastMouseY = mousePos.y;
            mouseMoveLock = false;
        });
    </script>
    <!-- script for loading blog posts from source -->
    <script type="module">
        let parameter = new URLSearchParams(window.location.search);
        // parse and render markdown content
        let file = new String(parameter.get("file")).split(/^\//, 1)[0].split(/\.md$/, 1)[0] + ".md";
        // parse markdown and do miscellanious after work
        fetch(post + file, {"credentials": "include"})
        .then(async (value) => await value.text())
        .then(text => {
            let new_text = text.replaceAll("\\\\", "\\\\\\\\");
            return new_text;
        })
        .then(text => {
            const starEscape = "\\Qva8WoTbfoyR2EIBW3RepMSImhHVO6aDVJUgzguM4VBChaIxnRYJKEZRCj55vJdunFksCLvgr1n5Fr4Xo80ZBPzWlSwRf8fZvrD3Mr9TH89Z6Ks9J6vLyi9S80uwGZHdfeuVJ1CaUULsOHBC4Yn0z4HiKPQPVx7NTqMdbHENpLMekF3ABW877AHGfNns5pA6OukoCoK2";
            const underscoreEscape = "\\ZUpO9HdAFCIFczYqAi3ihSBBnp536t0xKaTILBFNHVQiy0khsnjkNSBiplRPEZlbuh3YwJgGJRcjFA5uCTjUBopbQJMtuifA50FynqAFy9n00Z7iKwidDRoMbFKbFwK8CrXZguZ5oDjcwqCBTKuCMm1uXVYfjarsdnvQhDmN8HTYQUmeHI50Zg7Zu4UzwSH2DPI1jCUb";
            const md = markdownit('default');
            text = text.split('---', 3)[2];
            text = text.split('$$').map((x) => {
                let y = x.split('$');
                for (let i = 0; i < y.length; ++i) {
                    if (i % 2 == 0) { continue; }
                    y[i] = y[i].replaceAll('_', underscoreEscape);
                    y[i] = y[i].replaceAll('*', starEscape);
                }
                return y.join('$');
            }).join('$$');
            text = md.render(text);
            text = text.replaceAll(underscoreEscape, '_');
            text = text.replaceAll(starEscape, '*');
            document.getElementById("cont").innerHTML = text;
            return true;
        })
        .then(_any => {
            // chaining mathjax rendering
            let head = document.getElementsByTagName("head")[0];
            let script = document.createElement("script");
            script.setAttribute("id", "MathJax-script");
            script.setAttribute("src", "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js");
            head.appendChild(script);
        })
        .then(_any => {
            // there should be a marked plugin called marked-base-url that can presumably do this job for me
            // but unfortunately there are some configuration that a non-frontend engineer can barely understand
            // redirect links
            for (let alink of document.querySelectorAll("#cont a")) {
                let path = alink.href.split(site)[1];
                if (path) {
                    alink.href = site + `post.html?file=${path}`;
                }
            }
            // redirect image path
            for (let image of document.querySelectorAll("#cont img")) {
                let path = image.src.split(site)[1];
                if (path) {
                    image.src = post + path;
                }
            }
        })
        // the table of meta information about all files
        /* ---------------------------------------------------------------- //
            {
                "<path>": {
                    "topic": "about",
                    "timestamp":  "2024-02-30",
                }
            }
        // ---------------------------------------------------------------- */
        fetch(info + "table-meta.json?nocache=" + (new Date()).toISOString().split('T')[0], {"credentials": "include"})
        .then(async (value) => await value.text())
        .then(JSON.parse)
        .then((tableMeta) => {
            let current = tableMeta[file]["topic"];
            let cntAnother = 0;
            let cntCurrent = 0;
            let arrAnother = [];
            let arrCurrent = [];
            const lenAnother = 3;
            const lenCurrent = 2; 
            for (let [key, val] of Object.entries(tableMeta)) {
                if (val["topic"] == current) {
                    let randNum = Math.floor(Math.random() * cntCurrent);
                    if (cntCurrent < lenCurrent) {
                        arrCurrent.push([key, val]);
                    } else if (randNum < lenCurrent) {
                        arrCurrent[randNum] = [key, val];
                    }
                    cntCurrent += 1;
                } else {
                    let randNum = Math.floor(Math.random() * cntAnother);
                    if (cntAnother < lenAnother) {
                        arrAnother.push([key, val]);
                    } else if (randNum < lenAnother) {
                        arrAnother[randNum] = [key, val];
                    }
                    cntAnother += 1;
                }
            }
            return arrAnother.concat(arrCurrent);
        })
        .then((arrayMeta) => {
            console.log(arrayMeta);
            let prevList = document.getElementById("prev");
            for (let [href, info] of arrayMeta) {
                let prevItem = document.createElement("div");
                prevItem.setAttribute("class", "prev-item");
                let hrefRedirected = site + "post.html?file=" + href;
                prevItem.innerHTML = `
                    <h3 class="prev-item-title">${info["title"]}</h3>
                    <div class="prev-item-ahref">
                        <a href="${hrefRedirected}">Click Here to Read -> </a>
                    </div>
                `;
                prevList.appendChild(prevItem);
            }
        })
    </script>
</body>
